{% extends 'base.html' %}
{% load static %}

{% block title %}Appointment Calendar - Premium HMS{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'appointments:appointment_list' %}">Appointments</a></li>
<li class="breadcrumb-item active">Calendar</li>
{% endblock %}

{% block page_actions %}
<div class="d-flex gap-2">
    <a href="{% url 'appointments:appointment_list' %}" class="btn btn-outline-primary">
        <i class="bi bi-list"></i> List View
    </a>
    <a href="{% url 'appointments:appointment_create' %}" class="btn btn-primary">
        <i class="bi bi-calendar-plus"></i> Schedule New
    </a>
</div>
{% endblock %}

{% block extra_css %}
<style>
.calendar-container {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    overflow: hidden;
}

.calendar-header {
    background: linear-gradient(135deg, var(--primary-500), var(--primary-600));
    color: white;
    padding: 1.5rem;
    display: flex;
    justify-content: between;
    align-items: center;
}

.calendar-nav {
    display: flex;
    align-items: center;
    gap: 1rem;
}

.calendar-nav button {
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    padding: 0.5rem 1rem;
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.calendar-nav button:hover {
    background: rgba(255, 255, 255, 0.3);
}

.calendar-title {
    font-size: 1.5rem;
    font-weight: 600;
    margin: 0;
}

.calendar-grid {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 1px;
    background: var(--gray-200);
}

.calendar-day-header {
    background: var(--gray-50);
    padding: 1rem;
    text-align: center;
    font-weight: 600;
    color: var(--gray-700);
    font-size: 0.875rem;
}

.calendar-day {
    background: white;
    min-height: 120px;
    padding: 0.5rem;
    position: relative;
    cursor: pointer;
    transition: all 0.3s ease;
}

.calendar-day:hover {
    background: var(--gray-50);
}

.calendar-day.other-month {
    background: var(--gray-50);
    color: var(--gray-400);
}

.calendar-day.today {
    background: var(--primary-50);
    border: 2px solid var(--primary-500);
}

.day-number {
    font-weight: 600;
    margin-bottom: 0.5rem;
    font-size: 0.9rem;
}

.appointment-item {
    background: var(--primary-100);
    border-left: 3px solid var(--primary-500);
    padding: 0.25rem 0.5rem;
    margin-bottom: 0.25rem;
    border-radius: 4px;
    font-size: 0.75rem;
    cursor: pointer;
    transition: all 0.3s ease;
}

.appointment-item:hover {
    background: var(--primary-200);
    transform: translateX(2px);
}

.appointment-item.confirmed {
    background: var(--success-100);
    border-left-color: var(--success-500);
}

.appointment-item.pending {
    background: var(--warning-100);
    border-left-color: var(--warning-500);
}

.appointment-item.cancelled {
    background: var(--danger-100);
    border-left-color: var(--danger-500);
}

.appointment-time {
    font-weight: 600;
    color: var(--gray-700);
}

.appointment-patient {
    color: var(--gray-600);
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.calendar-legend {
    display: flex;
    gap: 1rem;
    padding: 1rem;
    background: var(--gray-50);
    border-top: 1px solid var(--gray-200);
}

.legend-item {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
}

.legend-color {
    width: 12px;
    height: 12px;
    border-radius: 2px;
}

.view-controls {
    display: flex;
    gap: 0.5rem;
    margin-bottom: 1rem;
}

.view-btn {
    padding: 0.5rem 1rem;
    border: 1px solid var(--gray-300);
    background: white;
    color: var(--gray-700);
    border-radius: 6px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.view-btn.active {
    background: var(--primary-500);
    color: white;
    border-color: var(--primary-500);
}

.view-btn:hover:not(.active) {
    background: var(--gray-50);
}
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- View Controls -->
    <div class="view-controls">
        <button class="view-btn active" data-view="month">Month</button>
        <button class="view-btn" data-view="week">Week</button>
        <button class="view-btn" data-view="day">Day</button>
    </div>

    <!-- Calendar Container -->
    <div class="calendar-container">
        <!-- Calendar Header -->
        <div class="calendar-header">
            <div class="calendar-nav">
                <button id="prevMonth">
                    <i class="bi bi-chevron-left"></i>
                </button>
                <h2 class="calendar-title" id="currentMonth">{{ current_month|date:"F Y" }}</h2>
                <button id="nextMonth">
                    <i class="bi bi-chevron-right"></i>
                </button>
            </div>
            <div class="calendar-nav">
                <button id="todayBtn">Today</button>
            </div>
        </div>

        <!-- Calendar Grid -->
        <div class="calendar-grid" id="calendarGrid">
            <!-- Day Headers -->
            <div class="calendar-day-header">Sun</div>
            <div class="calendar-day-header">Mon</div>
            <div class="calendar-day-header">Tue</div>
            <div class="calendar-day-header">Wed</div>
            <div class="calendar-day-header">Thu</div>
            <div class="calendar-day-header">Fri</div>
            <div class="calendar-day-header">Sat</div>

            <!-- Calendar Days will be generated by JavaScript -->
        </div>

        <!-- Calendar Legend -->
        <div class="calendar-legend">
            <div class="legend-item">
                <div class="legend-color" style="background: var(--success-500);"></div>
                <span>Confirmed</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: var(--warning-500);"></div>
                <span>Pending</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: var(--danger-500);"></div>
                <span>Cancelled</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background: var(--primary-500);"></div>
                <span>Completed</span>
            </div>
        </div>
    </div>
</div>

<!-- Appointment Modal -->
<div class="modal fade" id="appointmentModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Appointment Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="appointmentModalBody">
                <!-- Content will be loaded dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <a href="#" class="btn btn-primary" id="viewAppointmentBtn">View Details</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
class AppointmentCalendar {
    constructor() {
        this.currentDate = new Date();
        this.appointments = {{ appointments_json|safe }};
        this.currentView = 'month';
        
        this.init();
    }

    init() {
        this.bindEvents();
        this.renderCalendar();
    }

    bindEvents() {
        document.getElementById('prevMonth').addEventListener('click', () => {
            this.currentDate.setMonth(this.currentDate.getMonth() - 1);
            this.renderCalendar();
        });

        document.getElementById('nextMonth').addEventListener('click', () => {
            this.currentDate.setMonth(this.currentDate.getMonth() + 1);
            this.renderCalendar();
        });

        document.getElementById('todayBtn').addEventListener('click', () => {
            this.currentDate = new Date();
            this.renderCalendar();
        });

        // View controls
        document.querySelectorAll('.view-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.view-btn').forEach(b => b.classList.remove('active'));
                e.target.classList.add('active');
                this.currentView = e.target.dataset.view;
                this.renderCalendar();
            });
        });
    }

    renderCalendar() {
        const monthNames = [
            'January', 'February', 'March', 'April', 'May', 'June',
            'July', 'August', 'September', 'October', 'November', 'December'
        ];

        document.getElementById('currentMonth').textContent = 
            `${monthNames[this.currentDate.getMonth()]} ${this.currentDate.getFullYear()}`;

        this.renderDays();
    }

    renderDays() {
        const grid = document.getElementById('calendarGrid');
        const dayHeaders = grid.querySelectorAll('.calendar-day-header');
        
        // Remove existing day cells
        const existingDays = grid.querySelectorAll('.calendar-day');
        existingDays.forEach(day => day.remove());

        const year = this.currentDate.getFullYear();
        const month = this.currentDate.getMonth();
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const startDate = new Date(firstDay);
        startDate.setDate(startDate.getDate() - firstDay.getDay());

        const today = new Date();
        today.setHours(0, 0, 0, 0);

        for (let i = 0; i < 42; i++) {
            const cellDate = new Date(startDate);
            cellDate.setDate(startDate.getDate() + i);
            
            const dayCell = this.createDayCell(cellDate, month, today);
            grid.appendChild(dayCell);
        }
    }

    createDayCell(date, currentMonth, today) {
        const dayCell = document.createElement('div');
        dayCell.className = 'calendar-day';
        
        if (date.getMonth() !== currentMonth) {
            dayCell.classList.add('other-month');
        }
        
        if (date.getTime() === today.getTime()) {
            dayCell.classList.add('today');
        }

        const dayNumber = document.createElement('div');
        dayNumber.className = 'day-number';
        dayNumber.textContent = date.getDate();
        dayCell.appendChild(dayNumber);

        // Add appointments for this day
        const dayAppointments = this.getAppointmentsForDate(date);
        dayAppointments.forEach(appointment => {
            const appointmentEl = this.createAppointmentElement(appointment);
            dayCell.appendChild(appointmentEl);
        });

        // Add click event to create new appointment
        dayCell.addEventListener('click', () => {
            const dateStr = date.toISOString().split('T')[0];
            window.location.href = `{% url 'appointments:appointment_create' %}?date=${dateStr}`;
        });

        return dayCell;
    }

    createAppointmentElement(appointment) {
        const appointmentEl = document.createElement('div');
        appointmentEl.className = `appointment-item ${appointment.status.toLowerCase()}`;
        
        appointmentEl.innerHTML = `
            <div class="appointment-time">${appointment.time}</div>
            <div class="appointment-patient">${appointment.patient}</div>
        `;

        appointmentEl.addEventListener('click', (e) => {
            e.stopPropagation();
            this.showAppointmentModal(appointment);
        });

        return appointmentEl;
    }

    getAppointmentsForDate(date) {
        const dateStr = date.toISOString().split('T')[0];
        return this.appointments.filter(apt => apt.date === dateStr);
    }

    showAppointmentModal(appointment) {
        const modal = new bootstrap.Modal(document.getElementById('appointmentModal'));
        const modalBody = document.getElementById('appointmentModalBody');
        const viewBtn = document.getElementById('viewAppointmentBtn');

        modalBody.innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <strong>Patient:</strong> ${appointment.patient}
                </div>
                <div class="col-md-6">
                    <strong>Doctor:</strong> ${appointment.doctor}
                </div>
                <div class="col-md-6">
                    <strong>Date:</strong> ${appointment.date}
                </div>
                <div class="col-md-6">
                    <strong>Time:</strong> ${appointment.time}
                </div>
                <div class="col-12 mt-2">
                    <strong>Status:</strong> 
                    <span class="badge bg-${appointment.status === 'CONFIRMED' ? 'success' : 
                                           appointment.status === 'PENDING' ? 'warning' : 
                                           appointment.status === 'CANCELLED' ? 'danger' : 'primary'}">
                        ${appointment.status}
                    </span>
                </div>
                ${appointment.reason ? `<div class="col-12 mt-2"><strong>Reason:</strong> ${appointment.reason}</div>` : ''}
            </div>
        `;

        viewBtn.href = `{% url 'appointments:appointment_detail' 0 %}`.replace('0', appointment.id);
        modal.show();
    }
}

// Initialize calendar when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    new AppointmentCalendar();
});
</script>
{% endblock %}
