{% extends 'base.html' %}
{% load static %}

{% block title %}Bill #{{ bill.id }} - Premium HMS{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'billing:bill_list' %}">Bills</a></li>
<li class="breadcrumb-item active">Bill #{{ bill.id }}</li>
{% endblock %}

{% block page_actions %}
<div class="d-flex gap-2">
    {% if bill.status != 'PAID' %}
        <a href="{% url 'billing:payment_create' bill.pk %}" class="btn btn-success">
            <i class="bi bi-credit-card"></i> Record Payment
        </a>
    {% endif %}
    <a href="{% url 'billing:invoice' bill.pk %}" class="btn btn-primary" target="_blank">
        <i class="bi bi-printer"></i> Print Invoice
    </a>
    <a href="{% url 'billing:bill_edit' bill.pk %}" class="btn btn-warning">
        <i class="bi bi-pencil"></i> Edit
    </a>
    <a href="{% url 'billing:bill_list' %}" class="btn btn-outline-secondary">
        <i class="bi bi-arrow-left"></i> Back to Bills
    </a>
</div>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <!-- Main Bill Details -->
        <div class="col-lg-8">
            <!-- Bill Header -->
            <div class="card premium-card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h5 class="card-title mb-0">
                            <i class="bi bi-receipt"></i> Bill #{{ bill.id }}
                        </h5>
                        <span class="badge 
                            {% if bill.status == 'PAID' %}bg-success
                            {% elif bill.status == 'PENDING' %}bg-warning
                            {% elif bill.status == 'OVERDUE' %}bg-danger
                            {% elif bill.status == 'DRAFT' %}bg-secondary
                            {% else %}bg-info{% endif %} fs-6">
                            {{ bill.status|title }}
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="detail-group">
                                <label class="detail-label">Bill Date</label>
                                <p class="detail-value">{{ bill.bill_date|date:"F d, Y" }}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="detail-group">
                                <label class="detail-label">Due Date</label>
                                <p class="detail-value">
                                    {{ bill.due_date|date:"F d, Y" }}
                                    {% if bill.status == 'OVERDUE' %}
                                        <span class="text-danger ms-2">
                                            <i class="bi bi-exclamation-triangle"></i> Overdue
                                        </span>
                                    {% endif %}
                                </p>
                            </div>
                        </div>
                        {% if bill.appointment %}
                        <div class="col-md-6">
                            <div class="detail-group">
                                <label class="detail-label">Related Appointment</label>
                                <p class="detail-value">
                                    <a href="{% url 'appointments:appointment_detail' bill.appointment.pk %}" class="text-decoration-none">
                                        Appointment #{{ bill.appointment.id }}
                                    </a>
                                </p>
                            </div>
                        </div>
                        {% endif %}
                        <div class="col-md-6">
                            <div class="detail-group">
                                <label class="detail-label">Created</label>
                                <p class="detail-value">{{ bill.created_at|date:"F d, Y g:i A" }}</p>
                            </div>
                        </div>
                        {% if bill.description %}
                        <div class="col-12">
                            <div class="detail-group">
                                <label class="detail-label">Description</label>
                                <p class="detail-value">{{ bill.description }}</p>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Patient Information -->
            <div class="card premium-card mt-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-person"></i> Patient Information
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <div class="detail-group">
                                <label class="detail-label">Patient Name</label>
                                <p class="detail-value">
                                    <a href="{% url 'patients:patient_detail' bill.patient.pk %}" class="text-decoration-none">
                                        {{ bill.patient.user.get_full_name }}
                                    </a>
                                </p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="detail-group">
                                <label class="detail-label">Email</label>
                                <p class="detail-value">{{ bill.patient.user.email }}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="detail-group">
                                <label class="detail-label">Phone</label>
                                <p class="detail-value">{{ bill.patient.user.phone|default:"Not provided" }}</p>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="detail-group">
                                <label class="detail-label">Patient ID</label>
                                <p class="detail-value">#{{ bill.patient.id }}</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bill Items -->
            <div class="card premium-card mt-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-list-check"></i> Bill Items
                    </h5>
                </div>
                <div class="card-body">
                    {% if bill.bill_items.all %}
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Service</th>
                                        <th>Quantity</th>
                                        <th>Unit Price</th>
                                        <th>Total</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for item in bill.bill_items.all %}
                                    <tr>
                                        <td>{{ item.service_name }}</td>
                                        <td>{{ item.quantity }}</td>
                                        <td>${{ item.unit_price }}</td>
                                        <td>${{ item.total_price }}</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% else %}
                        <div class="text-center py-4">
                            <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                            <p class="text-muted mt-2">No items added to this bill</p>
                        </div>
                    {% endif %}
                </div>
            </div>

            <!-- Payment History -->
            {% if bill.payments.all %}
            <div class="card premium-card mt-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="bi bi-credit-card"></i> Payment History
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Amount</th>
                                    <th>Method</th>
                                    <th>Reference</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for payment in bill.payments.all %}
                                <tr>
                                    <td>{{ payment.payment_date|date:"M d, Y" }}</td>
                                    <td>${{ payment.amount }}</td>
                                    <td>{{ payment.payment_method|title }}</td>
                                    <td>{{ payment.reference_number|default:"-" }}</td>
                                    <td>
                                        <span class="badge 
                                            {% if payment.status == 'COMPLETED' %}bg-success
                                            {% elif payment.status == 'PENDING' %}bg-warning
                                            {% elif payment.status == 'FAILED' %}bg-danger
                                            {% else %}bg-secondary{% endif %}">
                                            {{ payment.status|title }}
                                        </span>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Sidebar -->
        <div class="col-lg-4">
            <!-- Bill Summary -->
            <div class="card premium-card">
                <div class="card-header">
                    <h5 class="card-title mb-0">Bill Summary</h5>
                </div>
                <div class="card-body">
                    <div class="bill-summary">
                        <div class="summary-row">
                            <span>Subtotal:</span>
                            <span>${{ bill.subtotal|default:0 }}</span>
                        </div>
                        <div class="summary-row">
                            <span>Tax:</span>
                            <span>${{ bill.tax_amount|default:0 }}</span>
                        </div>
                        {% if bill.discount_amount %}
                        <div class="summary-row">
                            <span>Discount:</span>
                            <span class="text-success">-${{ bill.discount_amount }}</span>
                        </div>
                        {% endif %}
                        <div class="summary-row total-row">
                            <span>Total Amount:</span>
                            <span>${{ bill.total_amount }}</span>
                        </div>
                        {% if bill.paid_amount %}
                        <div class="summary-row">
                            <span>Paid Amount:</span>
                            <span class="text-success">${{ bill.paid_amount }}</span>
                        </div>
                        <div class="summary-row balance-row">
                            <span>Balance Due:</span>
                            <span class="{% if bill.balance_due > 0 %}text-danger{% else %}text-success{% endif %}">
                                ${{ bill.balance_due }}
                            </span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card premium-card mt-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Quick Actions</h5>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        {% if bill.status != 'PAID' %}
                            <a href="{% url 'billing:payment_create' bill.pk %}" class="btn btn-success">
                                <i class="bi bi-credit-card"></i> Record Payment
                            </a>
                        {% endif %}
                        <a href="{% url 'billing:invoice' bill.pk %}" class="btn btn-primary" target="_blank">
                            <i class="bi bi-printer"></i> Print Invoice
                        </a>
                        <a href="{% url 'billing:bill_edit' bill.pk %}" class="btn btn-warning">
                            <i class="bi bi-pencil"></i> Edit Bill
                        </a>
                        <a href="{% url 'patients:patient_detail' bill.patient.pk %}" class="btn btn-outline-primary">
                            <i class="bi bi-person"></i> View Patient
                        </a>
                        {% if bill.appointment %}
                            <a href="{% url 'appointments:appointment_detail' bill.appointment.pk %}" class="btn btn-outline-info">
                                <i class="bi bi-calendar-event"></i> View Appointment
                            </a>
                        {% endif %}
                        <a href="{% url 'billing:bill_create' %}" class="btn btn-outline-success">
                            <i class="bi bi-plus-circle"></i> Create New Bill
                        </a>
                    </div>
                </div>
            </div>

            <!-- Bill Timeline -->
            <div class="card premium-card mt-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Bill Timeline</h5>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <div class="timeline-item">
                            <div class="timeline-marker bg-primary"></div>
                            <div class="timeline-content">
                                <h6>Bill Created</h6>
                                <p class="text-muted mb-0">{{ bill.created_at|date:"M d, Y g:i A" }}</p>
                            </div>
                        </div>
                        {% if bill.status == 'PAID' %}
                        <div class="timeline-item">
                            <div class="timeline-marker bg-success"></div>
                            <div class="timeline-content">
                                <h6>Payment Completed</h6>
                                <p class="text-muted mb-0">{{ bill.updated_at|date:"M d, Y g:i A" }}</p>
                            </div>
                        </div>
                        {% elif bill.status == 'OVERDUE' %}
                        <div class="timeline-item">
                            <div class="timeline-marker bg-danger"></div>
                            <div class="timeline-content">
                                <h6>Payment Overdue</h6>
                                <p class="text-muted mb-0">Due: {{ bill.due_date|date:"M d, Y" }}</p>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.detail-group {
    margin-bottom: 1.5rem;
}

.detail-label {
    font-size: 0.875rem;
    font-weight: 600;
    color: var(--gray-700);
    margin-bottom: 0.25rem;
    display: block;
}

.detail-value {
    font-size: 1rem;
    color: var(--gray-900);
    margin: 0;
}

.bill-summary {
    background: var(--gray-50);
    border-radius: 8px;
    padding: 1.5rem;
}

.summary-row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 0.75rem;
    font-size: 1rem;
}

.total-row {
    border-top: 2px solid var(--primary-500);
    padding-top: 0.75rem;
    margin-top: 0.75rem;
    font-weight: 600;
    font-size: 1.1rem;
    color: var(--primary-700);
}

.balance-row {
    border-top: 1px solid var(--gray-300);
    padding-top: 0.75rem;
    margin-top: 0.75rem;
    font-weight: 600;
}

.timeline {
    position: relative;
    padding-left: 2rem;
}

.timeline::before {
    content: '';
    position: absolute;
    left: 0.75rem;
    top: 0;
    bottom: 0;
    width: 2px;
    background: var(--gray-200);
}

.timeline-item {
    position: relative;
    margin-bottom: 1.5rem;
}

.timeline-marker {
    position: absolute;
    left: -2rem;
    top: 0.25rem;
    width: 12px;
    height: 12px;
    border-radius: 50%;
    border: 2px solid white;
    box-shadow: 0 0 0 2px var(--gray-200);
}

.timeline-content h6 {
    font-size: 0.9rem;
    font-weight: 600;
    margin-bottom: 0.25rem;
}

.timeline-content p {
    font-size: 0.8rem;
}
</style>
{% endblock %}
